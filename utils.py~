from pymongo import Connection
Connection=Connection('mongo.stuycs.org')

# to auth
db = Connection.admin
res=db.authenticate('ml7','ml7')
players=db.players

def get_players():
    db=Connection['EmotionStock']
    names=[]
    for line in players.find():
        names.append(line['name'])
    return names

#name:string
def add_user(name):
    db=Connection['EmotionStock']
    if not name in get_players():
        stocks={}
        player={"name":str(name),"money":"1000","soul":"100",'stocks':stocks}
        players.insert(player)

def authenticate(name):
    db=Connection["EmotionStock"]
    if not name in get_players():
        return False
    return True

def buy_stock(user,stock,count):
    db=Connection["EmotionStock"]
    if (authenticate(user)):
        stock={"stock":stock.getName(),"shares":count}
        user.update({"stocks":stocks},{"$push":{"stocks":stock}})
        return True
    return False
    
'''
def add_stock(name,stock,n,c):
    """
    calls changeMoney
    adds stock type & # of stocks
    deducts n(#of stock)*c(price per stock) from 'money'
    OUTLINE DONE
    """
    db=Connection['EmotionStock']
    user=db.players
    emotion={"emotion":stock, "amount":c}
    if hasMoney(name,n,c):
        if hasStock(name,stock):
            updateStock(name,stock,n,True)
        else:
            stocks=getStocks(name)
            nstocks=stocks.insert(emotion)
            users.update({'name':str(name)},{"$push":{'stocks':nstocks} } )
        changeMoney(name,n,c,True)

def remove_stock(name,stock,n,c):
    """
    calls changeMoney
    removes n amount from stock 'stock'
    adds n*c to 'money'
    """
    db=Connection['EmotionStock']
    user=db.players
    if hasStock(name,stock):
        updateStock(name,stock,n,False)
        changeMoney(name,n,c,False)
        

def changeMoney(name,n,c,buy):
    """
    Changes the money in a player's account after buy/sell stock
    name:used to identify player
    n:number of stocks
    c:price per stock
    'buy' is a boolean: True if buying stock; False otherwise
    DONE
    """
    db=Connection['EmotionStock']
    user=db.players
    cost=int(float(n))*int(float(c))
    myMoney=getMoney(name)
    if buy:
        myMoney=myMoney-cost
    else:
        myMoney=myMoney+cost
    user.update({'name':str(name)},{"$push": {"money":myMoney}})

def updateStock(name,stock,n,buy):
    """
    User already has stocks of a given emotion
    Updates the amount
    name: player
    stock: name of stock
    n: amount of stock
    buy: boolean; True if buying; False if selling
    DONE
    """
    #db=Collection['EmotionStock']
    #user=db.players
    myStocks=getStocks(name)
    thisStock=myStock.find({'emotion':str(stock)})
    orgAmt=thisStock['amount']
    newAmt=""
    if buy:
        newAmt=str(int(n)+int(orgAmt))
    else:
        newAmt=str(int(n)-int(orgAmt))
    if newAmt="0":
        myStocks.remove({"emotion":str(stock)}) #removes emotion if no stocks
    else:
        myStocks.update({"emotion":str(stock)},{"$push":{"amount":newAmt}})
    

def hasMoney(name,n,c):
    """
    verifies that user isn't bankrupt
    DONE
    """
    db=Connection['EmotionStock']
    user=db.players
    player=user.find({'name':str(name)})
    myMoney=float(player["money"])
    cost=int(n)*int(c)
    total=myMoney-cost
    return total>=0
    
def hasStock(name,stock):
    """
    returns boolean: True if has 'stock'; False if it doesn't
    DONE
    """
    stocks=getStocks(name)
    return (stocks.find({'name':str(stock)}).count())>0

def getStocks(name):
    """
    returns dictionary of stocks for a given player
    DONE
    """
    db=Connection['EmotionStock']
    user=db.players
    player=user.find({'name':str(name)})
    return player['stocks']

def getMoney(name):
    """
    returns player's money
    DONE
    """
    db=Connection['EmotionStock']
    user=db.players
    player=user.find({'name':str(name)})
    return float(player["money"])

'''

def delete_players():
    players.drop()

if __name__=="__main__":
    print get_players()
